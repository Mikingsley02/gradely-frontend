<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Students</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      background-color: #f8f9fa;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container { margin-top: 30px; flex: 1; }
    table { background-color: white; border-radius: 10px; overflow: hidden; }
    th { background-color: #212529; color: white; }
    tr:hover { background-color: #f1f3f5; }
    footer {
      text-align: center;
      padding: 20px;
      font-size: 0.9rem;
      background: #343a40;
      color: #fff;
      margin-top: auto;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Manage Students</h4>
    <a href="dashboard.html" class="btn btn-primary btn-sm">⬅ Dashboard</a>
  </div>

  <div class="d-flex justify-content-between mb-3">
    <button class="btn btn-success" onclick="window.location.href='create-student.html'">➕ Add Student</button>

    <div class="d-flex gap-2">
      <input type="text" id="searchInput" class="form-control" placeholder="Search by ID or Name" style="max-width:200px;">
      <button id="searchBtn" class="btn btn-primary">Search</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>ID</th>
          <th>Full Name</th>
          <th>Phone</th>
          <th>Parent Email</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="studentsTableBody">
        <tr><td colspan="5" class="text-center">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="editStudentModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5>Edit Student</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editStudentId">

        <div class="mb-2">
          <label>First Name</label>
          <input type="text" id="editFirstName" class="form-control">
        </div>

        <div class="mb-2">
          <label>Middle Name</label>
          <input type="text" id="editMiddleName" class="form-control">
        </div>

        <div class="mb-2">
          <label>Last Name</label>
          <input type="text" id="editLastName" class="form-control">
        </div>

        <div class="mb-2">
          <label>Phone</label>
          <input type="text" id="editPhone" class="form-control">
        </div>

        <div class="mb-2">
          <label>Parent Email</label>
          <input type="email" id="editParentEmail" class="form-control">
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success" id="saveEditBtn">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<footer>
  &copy; 2025 <strong>gradely.info</strong>. All rights reserved.<br>
  <a href="terms.html">Terms</a> •
  <a href="privacy.html">Privacy</a> •
  <a href="refund-policy.html">Refund Policy</a>
</footer>

<script>
const API_BASE = "https://gradely-backend-1.onrender.com";
const tableBody = document.getElementById("studentsTableBody");
const searchInput = document.getElementById("searchInput");
const searchBtn = document.getElementById("searchBtn");
const modal = new bootstrap.Modal(document.getElementById("editStudentModal"));

const schoolId = sessionStorage.getItem("school_id");
let allStudents = [];

if (!schoolId) {
  tableBody.innerHTML = `<tr><td colspan="5" class="text-danger text-center">❌ School not found</td></tr>`;
}

/* LOAD STUDENTS */
async function loadStudents() {
  try {
    const res = await fetch(`${API_BASE}/api/manage-students/${encodeURIComponent(schoolId)}`);
    const data = await res.json();

    if (!data.success || !data.students.length) {
      tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-warning">⚠️ No students found.</td></tr>`;
      return;
    }

    allStudents = data.students;
    renderTable(allStudents);
  } catch (err) {
    console.error(err);
    tableBody.innerHTML = `<tr><td colspan="5" class="text-danger text-center">❌ Failed to load students</td></tr>`;
  }
}

/* RENDER TABLE */
function renderTable(list) {
  tableBody.innerHTML = list.map(s => `
    <tr>
      <td>${s.student_id}</td>
      <td>${s.first_name} ${s.middle_name || ""} ${s.last_name}</td>
      <td>${s.phone || "-"}</td>
      <td>${s.parent_email || "-"}</td>
      <td>
        <button class="btn btn-sm btn-primary" onclick="editStudent('${s.student_id}')">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteStudent('${s.student_id}')">Delete</button>
      </td>
    </tr>
  `).join("");
}

/* SEARCH */
async function handleSearch() {
  const query = searchInput.value.trim();

  if (!query) {
    loadStudents();
    return;
  }

  try {
    const res = await fetch(
      `${API_BASE}/api/manage-students/${encodeURIComponent(schoolId)}/search/${encodeURIComponent(query)}`
    );
    const data = await res.json();

    if (!data.success || !data.students.length) {
      tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-warning">⚠️ No student found.</td></tr>`;
      return;
    }

    allStudents = data.students;
    renderTable(allStudents);
  } catch (err) {
    console.error(err);
  }
}

searchBtn.onclick = handleSearch;
searchInput.onkeydown = e => { if (e.key === "Enter") handleSearch(); };

/* EDIT */
function editStudent(id) {
  const s = allStudents.find(x => x.student_id === id);
  if (!s) return;

  editStudentId.value = s.student_id;
  editFirstName.value = s.first_name;
  editMiddleName.value = s.middle_name || "";
  editLastName.value = s.last_name;
  editPhone.value = s.phone || "";
  editParentEmail.value = s.parent_email || "";

  modal.show();
}

/* SAVE EDIT */
saveEditBtn.onclick = async () => {
  const payload = {
  first_name: editFirstName.value,
  middle_name: editMiddleName.value,
  last_name: editLastName.value,
  phone: editPhone.value,
  parent_email: editParentEmail.value
};


  const res = await fetch(`${API_BASE}/api/students/${editStudentId.value}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (res.ok) {
    modal.hide();
    loadStudents();
  } else {
    alert("❌ Failed to update student");
  }
};

/* DELETE WITH CONFIRMATION */
async function deleteStudent(id) {
  if (!confirm("⚠️ Are you sure you want to delete this student? This action cannot be undone.")) {
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/api/students/${id}`, {
  method: "DELETE"
});


    if (!res.ok) throw new Error("Delete failed");

    loadStudents();
  } catch (err) {
    alert("❌ Failed to delete student");
  }
}

loadStudents();
</script>

<script src="js/kaima-chatbot.js"></script>
<script src="js/session-timeout.js"></script>

</body>
</html>
