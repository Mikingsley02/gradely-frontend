<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gradely | Forgot Password</title>
<style>
  /* Reset & layout */
  * { margin:0; padding:0; box-sizing:border-box; }
  html, body { height:100%; font-family:sans-serif; background:#f0f4f8; display:flex; flex-direction:column; }

  /* Centered container */
  .container { 
    background:white; 
    padding:30px; 
    border-radius:12px; 
    width: 100%; 
    max-width: 400px; 
    box-shadow:0 4px 20px rgba(0,0,0,0.1); 
    margin:auto; 
    display:flex; 
    flex-direction:column;
  }

  h2 { text-align:center; margin-bottom:20px; }

  input, button { width:100%; padding:12px; margin:8px 0; border-radius:8px; border:1px solid #ccc; font-size:1rem; }
  button { background:#3498db; color:white; border:none; cursor:pointer; transition:all 0.3s; }
  button:hover { background:#2980b9; }

  .hidden { display:none; }
  .message { text-align:center; margin:10px 0; font-weight:600; color:#555; }

  /* Password field toggle */
  .password-wrapper { position:relative; }
  .toggle-password { position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; font-size:1.2em; color:#666; }
  .toggle-password:hover { color:#2e7d32; }

  /* Footer outside container */
  footer { 
    text-align:center; 
    font-size:0.85rem; 
    color:#666; 
    padding:10px 0; 
    margin-top:auto; 
    border-top:1px solid #eee; 
    width:100%;
    background:#f0f4f8;
  }
  footer a { color:#3498db; text-decoration:none; margin:0 5px; }
  footer a:hover { text-decoration:underline; }

  /* Responsive */
  @media (max-width:480px) {
    .container { padding:20px; }
    h2 { font-size:1.4rem; }
    input, button { padding:10px; font-size:0.95rem; }
    footer { font-size:0.8rem; }
  }
</style>
</head>
<body>
<div class="container">
  <h2>Forgot Password</h2>

  <!-- Step 1: Enter User ID -->
  <div id="step1">
    <input type="text" id="userId" placeholder="Enter your Student/Admin ID" required autofocus>
    <button id="requestCodeBtn">Send Reset Code</button>
    <p class="message" id="step1Msg"></p>
  </div>

  <!-- Step 2: Enter Code + New Password -->
  <div id="step2" class="hidden">
    <input type="text" id="resetCode" placeholder="Enter reset code" required>
    <div class="password-wrapper">
      <input type="password" id="newPassword" placeholder="Enter new password" required>
      <span class="toggle-password" id="togglePassword">üëÅÔ∏è</span>
    </div>
    <p id="passwordStrength" style="font-size:0.9rem; margin:5px 0;"></p>
    <button id="resetPasswordBtn">Reset Password</button>
    <p class="message" id="step2Msg"></p>
  </div>
</div>

<footer>
  ¬© 2026 <strong>gradely.info</strong>. All rights reserved. | Powered by RIS<br>
  <a href="terms.html">Terms</a> ‚Ä¢ 
  <a href="privacy.html">Privacy</a> ‚Ä¢ 
  <a href="refund-policy.html">Refund Policy</a>
</footer>

<script>
const API_BASE = window.location.hostname.includes("localhost")
  ? "http://localhost:3001/api/auth"
  : "https://api.gradely.info/api/auth";

const step1 = document.getElementById("step1");
const step2 = document.getElementById("step2");
const step1Msg = document.getElementById("step1Msg");
const step2Msg = document.getElementById("step2Msg");
const requestBtn = document.getElementById("requestCodeBtn");
const resetBtn = document.getElementById("resetPasswordBtn");
const togglePassword = document.getElementById("togglePassword");
const newPasswordInput = document.getElementById("newPassword");
const passwordStrength = document.getElementById("passwordStrength");

let currentUserId = null;

// Step 1: Request reset code
requestBtn.addEventListener("click", async () => {
  const userId = document.getElementById("userId").value.trim();
  if (!userId) return (step1Msg.textContent = "Please enter your ID");

  step1Msg.textContent = "Sending code...";
  requestBtn.disabled = true;

  try {
    const res = await fetch(`${API_BASE}/forgot-password`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message || "Failed");

    step1Msg.textContent = "‚úÖ Reset code sent!";
    currentUserId = userId;
    step1.classList.add("hidden");
    step2.classList.remove("hidden");
  } catch (err) {
    step1Msg.textContent = "‚ùå " + err.message;
    requestBtn.disabled = false;
  }
});

// Step 2: Toggle password visibility
togglePassword.addEventListener("click", () => {
  const type = newPasswordInput.type === "password" ? "text" : "password";
  newPasswordInput.type = type;
  togglePassword.textContent = type === "text" ? "üôà" : "üëÅÔ∏è";
});

// Step 2: Password strength
newPasswordInput.addEventListener("input", () => {
  const val = newPasswordInput.value;
  let strength = "Weak";
  if(val.length >= 6 && /[A-Z]/.test(val) && /[0-9]/.test(val)) strength = "Strong";
  else if(val.length >= 6) strength = "Medium";
  passwordStrength.textContent = `Password Strength: ${strength}`;
  passwordStrength.style.color = strength === "Strong" ? "green" : strength === "Medium" ? "orange" : "red";
});

// Step 2: Verify code + reset password
resetBtn.addEventListener("click", async () => {
  const code = document.getElementById("resetCode").value.trim();
  const newPassword = newPasswordInput.value.trim();
  if (!code || !newPassword) return (step2Msg.textContent = "Please fill all fields");

  step2Msg.textContent = "Resetting password...";
  resetBtn.disabled = true;

  try {
    const res = await fetch(`${API_BASE}/reset-password`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: currentUserId, code, newPassword })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message || "Failed");

    step2Msg.textContent = "‚úÖ Password reset successfully!";
    setTimeout(() => window.location.href = "login.html", 2000);
  } catch (err) {
    step2Msg.textContent = "‚ùå " + err.message;
  } finally {
    resetBtn.disabled = false;
  }
});
</script>
</body>
</html>
