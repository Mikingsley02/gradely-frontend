<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üì¶ Subscription | Gradely Info</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      background: #2d046e;
      width: 100%;
      padding: 20px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .brand { font-weight: 600; font-size: 1.1rem; }
    .container {
      background: #fff;
      color: #333;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 480px;
      margin-top: 80px;
      padding: 30px 25px;
      text-align: center;
    }
    h2 { margin-bottom: 10px; color: #2d046e; }
    p { font-size: 0.9rem; color: #555; margin-bottom: 20px; }
    .details {
      background: #f1f3f5;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: left;
      line-height: 1.6;
    }
    .details strong { color: #000; }
    .btn-group {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    .btn {
      flex: 1;
      min-width: 120px;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .btn-renew { background: #00c851; color: white; }
    .btn-renew:hover { background: #009c3b; }
    .btn-cancel { background: #6c757d; color: white; }
    .btn-cancel:hover { background: #5a6268; }
    .btn-upgrade { background: #00e676; color: #000; }
    .btn-upgrade:hover { background: #00c853; }
    .btn-compare { background: #3498db; color: white; }
    .btn-compare:hover { background: #2980b9; }
    .message { margin-top: 15px; font-size: 0.95rem; text-align: center; min-height: 22px; }
    .error { color: #e74c3c; }
    .success { color: #27ae60; }
    .back-btn {
      display: inline-block;
      background: #0c2461;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      margin-top: 20px;
      transition: all 0.3s ease;
    }
    .back-btn:hover { background: #1e3799; transform: scale(1.05); }
    footer {
      text-align: center;
      padding: 25px;
      font-size: 0.9rem;
      color: #eee;
      background: rgba(0, 0, 0, 0.1);
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      width: 100%;
      margin-top: auto;
    }
    footer a { color: #00d2ff; text-decoration: none; margin: 0 6px; }
    @media (max-width: 600px) {
      .btn-group { flex-direction: column; }
      .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">üéì Gradely.info ‚Äî Subscription</div>
  </header>

  <div class="container">
    <h2>üì¶ Your Subscription</h2>
    <p>Manage your current plan and renewal settings.</p>

    <div class="details">
      <p><strong>Plan:</strong> <span id="plan">Loading...</span></p>
      <p><strong>Status:</strong> <span id="status">Loading...</span></p>
      <p><strong>Expires:</strong> <span id="renewal">Loading...</span></p>
      <p id="cancelStatus" style="display:none; margin-top:8px; font-size:0.85rem; color:#e74c3c;">
        <strong>‚ö†Ô∏è Auto-renewal disabled</strong><br>
        Your access continues until expiry date above
      </p>
    </div>

    <div class="btn-group" id="mainButtons">
      <button class="btn btn-renew" onclick="renewSubscription()" id="renewBtn">üîÑ Renew Now</button>
      <button class="btn btn-cancel" onclick="cancelSubscription()" id="cancelBtn">‚èπÔ∏è Cancel Auto-Renew</button>
      <button class="btn btn-upgrade" onclick="upgradeToPro()" id="upgradeBtn" style="display:none;">‚ú® Upgrade to Pro</button>
      <button class="btn btn-compare" onclick="window.location.href='plan-comparison.html'">üìä Compare Plans</button>
    </div>

    <div class="message" id="message"></div>
    <a href="dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>
  </div>

  <footer>
    ¬© 2026 <strong>gradely.info</strong>. All rights reserved. | Powered by RIS<br>
    <a href="terms.html">Terms</a> ‚Ä¢ 
    <a href="privacy.html">Privacy</a> ‚Ä¢ 
    <a href="refund-policy.html">Refund Policy</a>
  </footer>

  <script>
    let schoolId = null;
    let currentExpiry = null;
    let selectedPlan = null;

    document.addEventListener("DOMContentLoaded", async () => {
      schoolId = localStorage.getItem("school_id") || sessionStorage.getItem("school_id");
      if (!schoolId) {
        alert("Session expired. Please log in again.");
        window.location.href = "admin-login.html";
        return;
      }
      await fetchSubscriptionStatus();
    });

    async function fetchSubscriptionStatus() {
      try {
        // ‚úÖ FIXED: Removed trailing spaces in API URL
        const API_BASE = 'https://api.gradely.info';
        const res = await fetch(`${API_BASE}/api/subscription/status?school_id=${encodeURIComponent(schoolId)}`, {
          credentials: 'include'
        });
        
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (data.success) {
          document.getElementById('plan').textContent = data.plan.charAt(0).toUpperCase() + data.plan.slice(1);
          
          const statusEl = document.getElementById('status');
          statusEl.textContent = data.isActive ? 'Active' : 'Expired';
          statusEl.className = data.isActive ? '' : 'error';
          
          const renewalEl = document.getElementById('renewal');
          const cancelStatusEl = document.getElementById('cancelStatus');
          
          if (data.expiryDate && data.expiryDate !== 'null') {
            currentExpiry = new Date(data.expiryDate);
            renewalEl.textContent = currentExpiry.toLocaleDateString('en-GB', {
              day: 'numeric', month: 'short', year: 'numeric'
            });
            
            // ‚úÖ FIXED: Only show cancel status IF subscription is cancelled AND expiry is in future
            const today = new Date();
            if (data.subscriptionStatus === 'cancelled' && currentExpiry > today) {
              cancelStatusEl.style.display = 'block';
              document.getElementById('cancelBtn').style.display = 'none'; // Hide cancel button after cancelled
            } else {
              cancelStatusEl.style.display = 'none'; // ‚úÖ HIDE FOR ACTIVE SUBSCRIPTIONS
              
              // Only show cancel button for active subscriptions that aren't cancelled
              if (data.isActive && data.subscriptionStatus !== 'cancelled') {
                document.getElementById('cancelBtn').style.display = 'block';
              } else {
                document.getElementById('cancelBtn').style.display = 'none';
              }
            }
          } else {
            renewalEl.textContent = 'Not set';
            cancelStatusEl.style.display = 'none';
          }

          // ‚úÖ BUTTON LOGIC: Show appropriate buttons based on plan and status
          if (data.isActive) {
            if (data.plan === 'basic') {
              document.getElementById('renewBtn').style.display = 'none';
              document.getElementById('upgradeBtn').style.display = 'block';
            } else if (data.plan === 'pro') {
              document.getElementById('upgradeBtn').style.display = 'none';
              document.getElementById('renewBtn').style.display = 'block';
            }
          } else {
            // Expired: Show plan selection
            document.getElementById('mainButtons').style.display = 'none';
            showPlanSelection(data.plan);
          }
        }
      } catch (err) {
        console.error("‚ùå Error:", err);
        document.getElementById('message').innerHTML = `<span class="error">Unable to load subscription: ${err.message || 'Network error'}</span>`;
      }
    }

    function cancelSubscription() {
      if (!schoolId) {
        alert("Error: School ID not found. Please log in again.");
        return;
      }
      
      const expiryStr = currentExpiry ? currentExpiry.toLocaleDateString('en-GB', {
        day: 'numeric', month: 'short', year: 'numeric'
      }) : 'your current term end date';
      
      if (!confirm(`‚èπÔ∏è Cancel Auto-Renewal?\n\n‚úÖ Your subscription remains ACTIVE until: ${expiryStr}\n‚úÖ Full access continues until expiry\n‚úÖ No auto-renewal after expiry\n‚úÖ Renew manually anytime before/after expiry\n\nDo you want to proceed?`)) {
        return;
      }
      
      const btn = document.getElementById('cancelBtn');
      btn.disabled = true;
      btn.textContent = "Processing...";
      document.getElementById('message').innerHTML = '';

      // ‚úÖ FIXED: Get JWT token and include in headers
      const token = localStorage.getItem('token') || localStorage.getItem('admin_token');
      
      // ‚úÖ FIXED: Removed trailing spaces in URL
      fetch('https://api.gradely.info/api/subscription/cancel', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}` // ‚úÖ ADDED AUTH TOKEN
        },
        body: JSON.stringify({ school_id: schoolId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          document.getElementById('message').innerHTML = `<span class="success">‚úÖ ${data.message}</span>`;
          setTimeout(() => location.reload(), 2000);
        } else {
          throw new Error(data.message || "Request failed");
        }
      })
      .catch(err => {
        console.error("Cancellation error:", err);
        // ‚úÖ FIXED: Better error message for auth failures
        document.getElementById('message').innerHTML = `<span class="error">‚ùå ${err.message || 'Authentication failed. Please logout and login again.'}</span>`;
        btn.disabled = false;
        btn.textContent = "‚èπÔ∏è Cancel Auto-Renew";
      });
    }

    function renewSubscription() {
      if (!schoolId) return alert("Error: School ID not found.");
      window.location.href = `pay.html?school_id=${encodeURIComponent(schoolId)}&plan=pro&renew=true`;
    }

    function upgradeToPro() {
      if (!schoolId) return alert("Error: School ID not found.");
      window.location.href = `pay.html?school_id=${encodeURIComponent(schoolId)}&plan=pro&upgrade=true`;
    }

    // ‚úÖ COMPLETE PLAN SELECTION FUNCTIONS
    function showPlanSelection(previousPlan) {
      const container = document.querySelector('.container');
      
      const planSelectionHTML = `
        <div id="planSelection" style="margin-bottom: 20px;">
          <h3 style="color: #2d046e; margin-bottom: 15px;">Choose Your Plan to Reactivate</h3>
          
          <div style="text-align: center; margin-bottom: 15px;">
            <a href="plan-comparison.html" style="color: #3498db; text-decoration: none; font-weight: 600; display: inline-block; padding: 8px 15px; border: 2px solid #3498db; border-radius: 20px; background: rgba(52, 152, 219, 0.1);">
              üìä View Detailed Plan Comparison
            </a>
          </div>
          
          <div style="display: flex; gap: 15px; margin-bottom: 15px;">
            <div style="flex: 1; background: #f8f9fa; border: 2px solid #adb5bd; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.3s;" 
                 onclick="selectPlan('basic')" id="basicPlanCard">
              <h4 style="color: #495057; margin-bottom: 10px;">üìù Basic</h4>
              <p style="font-size: 1.5rem; font-weight: bold; color: #000; margin: 10px 0;">‚Ç¶16,800</p>
              <p style="font-size: 0.9rem; color: #6c757d;">Per Term</p>
              <ul style="text-align: left; margin-top: 10px; font-size: 0.85rem; color: #495057;">
                <li>‚úì Student Management</li>
                <li>‚úì Result Upload</li>
                <li>‚úì Basic Reporting</li>
              </ul>
            </div>
            
            <div style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 2px solid #667eea; border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.3s;" 
                 onclick="selectPlan('pro')" id="proPlanCard">
              <h4 style="color: #fff; margin-bottom: 10px;">üöÄ Pro</h4>
              <p style="font-size: 1.5rem; font-weight: bold; color: #fff; margin: 10px 0;">‚Ç¶19,200</p>
              <p style="font-size: 0.9rem; color: rgba(255,255,255,0.9);">Per Term</p>
              <ul style="text-align: left; margin-top: 10px; font-size: 0.85rem; color: #fff;">
                <li>‚úì All Basic Features</li>
                <li>‚úì Class Management</li>
                <li>‚úì SMS Announcements</li>
                <li>‚úì Bulk Operations</li>
                <li>‚úì Priority Support</li>
              </ul>
            </div>
          </div>
          
          <button class="btn btn-renew" onclick="confirmPlanSelection()" id="confirmPlanBtn" disabled 
                  style="width: 100%; background: #6c757d; color: #fff; margin-top: 10px;">
            ‚úÖ Continue with Selected Plan
          </button>
        </div>
      `;
      
      const messageDiv = document.getElementById('message');
      messageDiv.insertAdjacentHTML('beforebegin', planSelectionHTML);
      
      if (previousPlan === 'basic') selectPlan('basic');
      else selectPlan('pro');
    }

    function selectPlan(plan) {
      selectedPlan = plan;
      document.getElementById('basicPlanCard').style.border = '2px solid #adb5bd';
      document.getElementById('basicPlanCard').style.background = '#f8f9fa';
      document.getElementById('proPlanCard').style.border = '2px solid #667eea';
      document.getElementById('proPlanCard').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      
      if (plan === 'basic') {
        document.getElementById('basicPlanCard').style.border = '3px solid #28a745';
        document.getElementById('basicPlanCard').style.background = '#e8f5e9';
      } else {
        document.getElementById('proPlanCard').style.border = '3px solid #ffc107';
        document.getElementById('proPlanCard').style.background = 'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)';
      }
      
      document.getElementById('confirmPlanBtn').disabled = false;
      document.getElementById('confirmPlanBtn').style.background = '#00c851';
      document.getElementById('confirmPlanBtn').style.color = '#fff';
      document.getElementById('confirmPlanBtn').textContent = `‚úÖ Continue with ${plan.toUpperCase()} Plan`;
    }

    function confirmPlanSelection() {
      if (!selectedPlan) {
        alert("Please select a plan first!");
        return;
      }
      window.location.href = `pay.html?school_id=${encodeURIComponent(schoolId)}&plan=${selectedPlan}&renew=true`;
    }
  </script>
</body>
</html>